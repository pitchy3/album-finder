# Docker Compose override file for scaling Album Finder
# Usage: 
#   Run: docker compose -f docker-compose.yml -f docker-compose.scale.yml up -d
#   Stop: docker compose -f docker-compose.yml -f docker-compose.scale.yml down

services:
  # Primary app instance (inherits from base config)
  album-finder:

  # Second app instance
  album-finder-app-2:
    image: ghcr.io/pitchy3/album-finder:latest
    restart: unless-stopped
    user: "${PUID:-1000}:${PGID:-1000}"
    depends_on:
      redis:
        condition: service_healthy
      album-finder-init:
        condition: service_completed_successfully
    ports:
      - "${APP_PORT_2:-3011}:3000"  # Second instance on port 3011
    volumes:
      - albumfinder-data:/app/server/data  # Shared volume
    environment:
      # Server configuration
      PORT: 3000
      NODE_ENV: production
      # Redis configuration
      REDIS_URL: redis://redis:6379
      # Session configuration
      SESSION_SECRET: ${SESSION_SECRET:-change-me-in-production}
      COOKIE_SECURE: ${COOKIE_SECURE:-true}
      ENABLE_CSRF: ${ENABLE_CSRF:-true}
      DEBUG: ${DEBUG:-false}
      LIDARR_WEBHOOK_KEY: ${LIDARR_WEBHOOK_KEY}
      API_KEY: ${API_KEY}
      # Timezone
      TZ: ${TZ:-UTC}
      # Cache configuration
      CACHE_TTL: ${CACHE_TTL:-3600}
      MAX_CACHE_SIZE: ${MAX_CACHE_SIZE:-1000}
      MAX_CACHE_MEMORY: ${MAX_CACHE_MEMORY:-100}
      # Rate limiting configuration
      MUSICBRAINZ_DELAY: ${MUSICBRAINZ_DELAY:-1000}
      MAX_CONCURRENT_REQUESTS: ${MAX_CONCURRENT_REQUESTS:-10}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT:-30000}
    networks:
      - internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # Third app instance
  album-finder-app-3:
    image: ghcr.io/pitchy3/album-finder:latest
    restart: unless-stopped
    user: "${PUID:-1000}:${PGID:-1000}"
    depends_on:
      redis:
        condition: service_healthy
      album-finder-init:
        condition: service_completed_successfully
    ports:
      - "${APP_PORT_3:-3021}:3000"  # Third instance on port 3021
    volumes:
      - albumfinder-data:/app/server/data  # Shared volume
    environment:
      # Server configuration
      PORT: 3000
      NODE_ENV: production
      # Redis configuration
      REDIS_URL: redis://redis:6379
      # Session configuration
      SESSION_SECRET: ${SESSION_SECRET:-change-me-in-production}
      COOKIE_SECURE: ${COOKIE_SECURE:-true}
      ENABLE_CSRF: ${ENABLE_CSRF:-true}
      DEBUG: ${DEBUG:-false}
      LIDARR_WEBHOOK_KEY: ${LIDARR_WEBHOOK_KEY}
      API_KEY: ${API_KEY}
      # Timezone
      TZ: ${TZ:-UTC}
      # Cache configuration
      CACHE_TTL: ${CACHE_TTL:-3600}
      MAX_CACHE_SIZE: ${MAX_CACHE_SIZE:-1000}
      MAX_CACHE_MEMORY: ${MAX_CACHE_MEMORY:-100}
      # Rate limiting configuration
      MUSICBRAINZ_DELAY: ${MUSICBRAINZ_DELAY:-1000}
      MAX_CONCURRENT_REQUESTS: ${MAX_CONCURRENT_REQUESTS:-10}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT:-30000}
    networks:
      - internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

networks:
  internal:
    external: false

volumes:
  albumfinder-data:
    driver: local  # Share the volume created by base docker-compose.yml